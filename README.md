# Snyk Orb for CircleCI

Use the Snyk orb to easily test your application dependencies and Docker images
for security issues as part of your CircleCI workflow

## Getting Started

1. Follow the [Orb Quick Start Guide](https://circleci.com/orbs/registry/orb/snyk/snyk#quick-start)
   to enable usage of Orbs in your project workflow
2. Add an environment variable (`SNYK_TOKEN`) with your Snyk API token, which
   you can get from your [Snyk account](https://app.snyk.io/account).
3. In the app build job, call `snyk/scan`

## Examples

### Scan App Dependencies

```yaml
version: 2.1

  orbs:
    snyk: snyk/snyk@x.y.z

  jobs:
    build:
      docker:
        - image: cci/node:lts
      steps:
        - checkout
        - run: npm ci
        - snyk/scan
```

### Scan Docker Image

```yaml
version: 2.1

orbs:
  snyk: snyk/snyk@x.y.z

jobs:
  build:
    environment:
      IMAGE_NAME: myrepo/myapp
    docker:
        - image: circleci/buildpack-deps:stretch
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build Docker image
          command: docker build -t $IMAGE_NAME:latest .
      - snyk/scan:
          token-variable: SNYK_TOKEN
          docker-image-name: $IMAGE_NAME:latest
          target-file: "Dockerfile"
```

### Advanced Example

```yaml
version: 2.1

orbs:
  snyk: snyk/snyk@x.y.z

jobs:
  build:
    docker:
    - image: cci/node:lts
    steps:
    - checkout
    - run:
        command: npm ci
    - snyk/scan:
        token-variable: CICD_SNYK_TOKEN                           # used to define the name of your Snyk token env var (default: SNYK_TOKEN)
        severity-threshold: high                                  # only fail if detected high severity vulnerabilities
        protect: true                                             # apply patches specified in a .snyk policy file (generated by running the [snyk wizard](https://snyk.io/docs/cli-wizard/))
        fail-on-issues: false                                     # don't fail even if issues detected (not recommended!)
        monitor-on-build: true                                    # create a snapshot of apps dependencies on snyk.io, for continous monitoring (recommended!)
        project: ${CIRCLE_PROJECT_REPONAME}/${CIRCLE_BRANCH}-app  # use this to save the snapshot under specific names
        organization: ${SNYK_CICD_ORGANIZATION}                   # save reports under a specific Snyk organization
```

## Orb Parameters

Full reference docs https://circleci.com/orbs/registry/orb/snyk/snyk

| Parameter | Description | Required | Default | Type |
| ----------| ----------- | -------- | ------- | ---- |
| token-variable | Name of env var containing your Snyk API token | no | SNYK_TOKEN | env_var_name |
| severity-threshold | Only report vulnerabilities of provided level or higher (low/medium/high/critical) | no | low | low \| med \| high \| critical |
| protect | Protect the app by applying patches specified in your .snyk file (after running the Snyk wizard) | no | false | boolean |
| fail-on-issues | This specifies if builds should fail if Snyk detects issues | no | true | boolean |
| monitor-on-build | Take a snapshot of the application for continuous monitoring | no | true | boolean |
| target-file | The path to the manifest file to be used by Snyk. Should be provided if non-standard | no | - | string |
| docker-image-name | The image name, if scanning a container image | no | - | string |
| organization | The Snyk Organization ID (see Organization-level Settings tab in the Snyk UI) under which this project should be tested and monitored. | no | - | string |
| project | A custom name for the Snyk project to be created on snyk.io | no | - | string |
| additional-arguments | Refer to the Snyk CLI help page for information on additional arguments | no | - | string |
| os | The CLI OS version to download | no | linux | linux \| macos \| alpine |
| install-alpine-dependencies | For the alpine CLI, should extenral dependencies be installed | no | true | boolean |

## Screenshots

### Snyk found high severity vulnerabilies in app and failed the workflow

![Snyk Found Vulns](pictures/snyk_found_vulns.png)

### Continuous Monitoring on snyk.io

#### Issues Report

![Issues Report on snyk.io](pictures/snykio_report.png)

#### Dependency Tree

![Dependency Tree on snyk.io](pictures/snykio_deptree.png)

## Development

The Snyk orb follows standard CircleCI orb development practices. Releases
are trigger automatically based on tags in the commit messages such as
`[semver:patch]`, `[semver:minor]`, `[semver:release]`. This differs slightly
from Snyks usual usage of `feat`, `fix` etc. to keep us open to community
contributions and make it easier for us to stay aligned with Circle's
expectations
